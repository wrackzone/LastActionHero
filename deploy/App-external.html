<!DOCTYPE html>
<html>
<head>
    <title>LastActionHero</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var me=this;Deft.Promise.all([me.readWorkspaces()],me).then({success:function(results){console.log("results",results);var workspaces=_.first(results);Deft.Promise.all([me.setUserCounts(workspaces),me.setFeatureCounts(workspaces),me.setFeatureTIP(workspaces)],me).then({success:function(results){console.log("workspaces",_.map(workspaces,function(w){return w.get("Name")+"-"+w.get("UserWorkspaceCount")+":"+w.get("ProjectsCount")})),me.createChart(me.prepareChartData(workspaces))}})}})},createChart:function(series){var me=this;me.setLoading(!1),_.isUndefined(me.chart)||me.remove(me.chart),me.chart=Ext.create("Rally.technicalservices.lahChart",{itemId:"rally-chart",chartData:{series:series},title:"Workspace Visualization"}),me.add(me.chart)},prepareChartData:function(workspaces){var seriesData=_.map(workspaces,function(ws){return{name:ws.get("Name"),data:[{x:ws.get("FeatureTIPValue"),y:ws.get("WorkspaceFeatureCount"),z:ws.get("UserWorkspaceCount")}]}});return console.log("seriesData",seriesData),seriesData},setFeatureCounts:function(workspaces){console.log("Getting Features");var me=this,deferred=Ext.create("Deft.Deferred");return me.readPortfolioItems(workspaces).then({success:function(values){console.log("values",values),_.each(workspaces,function(workspace,i){console.log(workspace.get("Name"),values[i].length),workspace.set("WorkspaceFeatureCount",values[i].length)}),deferred.resolve([])},failure:function(error){console.log("Error:",error)}}),deferred.promise},setFeatureTIP:function(workspaces){console.log("Getting Feature TIP");var me=this,deferred=Ext.create("Deft.Deferred"),getLastTIPFromValue=function(value){var scope=_.first(value.scopes);if(0===scope.dataPoints.length)return 0;var datapoint=_.last(scope.dataPoints),metricValueKey=_.first(_.keys(datapoint.data)),metricValue=datapoint.data[metricValueKey].value;return metricValue};return me.readFeatureMetrics(workspaces).then({success:function(values){console.log("Workspace Insights API:",values),_.each(workspaces,function(workspace,i){workspace.set("FeatureTIPValue",getLastTIPFromValue(values[i]))}),deferred.resolve([])}}),deferred.promise},setProjectCounts:function(workspaces){var me=this,deferred=Ext.create("Deft.Deferred");return me.readProjects(workspaces).then({success:function(values){console.log("project values",values),_.each(workspaces,function(workspace,i){workspace.set("WorkspaceProjects",values[i]),workspace.set("ProjectsCount",values[i].length)}),deferred.resolve([])}}),deferred.promise},setUserCounts:function(workspaces){console.log("Getting Users");var me=this,deferred=Ext.create("Deft.Deferred");return me.readUsers(workspaces).then({success:function(values){_.each(workspaces,function(ws,i){ws.set("UserWorkspaceCount",values[i].length)}),deferred.resolve([])}}),deferred.promise},readProjects:function(workspaces){var me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("Project",["Name","State"],[],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},readPortfolioItems:function(workspaces){var createFeatureFilter=function(){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:">",value:"2015-01-01T00:00:00.000Z"});return filter},me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("PortfolioItem",["FormattedID"],[],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){console.log("error",error),deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},readFeatureMetrics:function(workspaces){var insightsAPI=function(workspace){var deferred=Ext.create("Deft.Deferred"),metrics=["TimeInProcessFeatureStart0P50"],workspace=workspace.get("ObjectID"),lastMonth=moment(),firstMonth=moment().subtract(6,"months"),baseUrl="https://rally1.rallydev.com/insight/data",granularity="month",url=baseUrl+"?"+"granularity="+granularity+"&metrics="+metrics.join()+"&workspaces="+workspace+"&start-date="+firstMonth.format("YYYY-MM")+"&end-date="+lastMonth.format("YYYY-MM");return Ext.Ajax.request({url:url,success:function(response,opts){var obj=Ext.decode(response.responseText);deferred.resolve(obj)},failure:function(response,opts){console.log("server-side failure with status code "+response.status)}}),deferred.promise},me=this,promises=_.map(workspaces,function(workspace){return insightsAPI(workspace)});return Deft.Promise.all(promises)},readWorkspacePermissions:function(){var me=this,deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("WorkspacePermission",["Workspace","User","Name","Role"]).then({scope:this,success:function(permissions){console.log("Permissions:",permissions.length);var data=_.map(permissions,function(p){return p.data});deferred.resolve(data)}}),deferred.promise},readWorkspaces:function(){var deferred=Ext.create("Deft.Deferred");return this._loadAStoreWithAPromise("Subscription",["Name","Workspaces"]).then({success:function(subs){var sub=_.first(subs);sub.getCollection("Workspaces").load({fetch:["ObjectID","Name","State"],callback:function(records,operation,success){console.log("workspaces",_.map(records,function(r){return r.get("Name")}));var recs=_.filter(records,function(r){return"Closed"!==r.get("State")&&-1==r.get("Name").toLowerCase().indexOf("kfwang")});console.log("Workspace Count:",recs.length),deferred.resolve(recs)}})},scope:this}),deferred.promise},readUsers:function(workspaces){var usersFilter=function(){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"WorkspacePermission",operator:"!=",value:"No Access"});return filter=filter.and(Ext.create("Rally.data.wsapi.Filter",{property:"Disabled",operator:"=",value:!1}))},me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("User",["UserName"],[usersFilter()],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},_loadAStoreWithAPromise:function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise}});
                Ext.define("Rally.technicalservices.lahChart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{colors:["#E0E0E0","#00a9e0","#fad200","#8dc63f"],chart:{type:"bubble"},title:{text:"Progress by Project"},xAxis:{title:{text:"Median Feature TIP"}},yAxis:[{title:{text:"# Portfolio Items"}}],plotOptions:{bubble:{tooltip:{headerFormat:"<b>{series.name}</b><br>",pointFormat:"TIP:{point.x}, Portfolio Items:{point.y}, Users:{point.z}"}}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"LastActionHero",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
