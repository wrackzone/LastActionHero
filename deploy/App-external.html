<!DOCTYPE html>
<html>
<head>
    <title>LastActionHero</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{yAxisType:"Story"}},launch:function(){var me=this;me.setLoading(!0),Deft.Promise.all([me.readWorkspaces()],me).then({success:function(results){me.setLoading(!1),console.log("results",results);var workspaces=_.first(results);Deft.Promise.all([me.setUserCounts(workspaces),me.setFeatureCounts(workspaces),me.setFeatureTIP(workspaces),me.setUserActivity(workspaces),me.setWorkspacePortfolioItemCounts(workspaces),me.setWorkspaceStoryCounts(workspaces),me.setWorkspaceDefectCounts(workspaces)],me).then({success:function(results){console.log("workspaces",_.map(workspaces,function(w){return w.get("Name")+"-"+w.get("UserWorkspaceCount")+":"+w.get("ProjectsCount")})),me.createChart(me.prepareChartData(workspaces))},failure:function(error){console.log("error---",error)}})}})},createChart:function(series){var me=this;me.setLoading(!1),_.isUndefined(me.chart)||me.remove(me.chart),me.chart=Ext.create("Rally.technicalservices.lahChart",{itemId:"rally-chart",chartData:{series:series},title:"Workspace Visualization"}),me.add(me.chart)},prepareChartData:function(workspaces){var me=this,seriesData=_.map(workspaces,function(ws){var snapshots=ws.get("WorkspaceUserActivity"),features=ws.get("WorkspaceFeatureCount"),totalUsers=ws.get("UserWorkspaceCount"),featureRatio=features>0?Math.round(100*(snapshots/features))/100:0,activityRatio=totalUsers>0?Math.round(100*(snapshots/totalUsers))/100:0;featureRatio=_.isNaN(featureRatio)?0:featureRatio,activityRatio=_.isNaN(activityRatio)?0:activityRatio;var yAxisField=me.getSetting("yAxisType");return yAxisField=("Story"===yAxisField?"HierarchicalRequirement":yAxisField)+"Count",{name:ws.get("Name"),data:[{x:ws.get("FeatureTIPValue"),y:ws.get(yAxisField),z:ws.get("UserWorkspaceCount"),featureRatio:featureRatio,activityRatio:activityRatio,snapshots:snapshots,portfolioitems:ws.get("PortfolioItemCount"),defects:ws.get("DefectCount"),stories:ws.get("HierarchicalRequirementCount")}]}});return console.log("seriesData",seriesData),console.log("seriesData",_.map(seriesData,function(sd){return _.first(sd.data).y})),seriesData},setFeatureCounts:function(workspaces){console.log("Getting Features");var me=this,deferred=Ext.create("Deft.Deferred");return me.readPortfolioItems(workspaces).then({success:function(values){console.log("values",values),_.each(workspaces,function(workspace,i){console.log(workspace.get("Name"),values[i].length),workspace.set("WorkspaceFeatureCount",values[i].length)}),deferred.resolve([])},failure:function(error){console.log("Error:",error)}}),deferred.promise},setFeatureTIP:function(workspaces){console.log("Getting Feature TIP");var me=this,deferred=Ext.create("Deft.Deferred"),getLastTIPFromValue=function(value){var scope=_.first(value.scopes);if(0===scope.dataPoints.length)return 0;var datapoint=_.last(scope.dataPoints),metricValueKey=_.first(_.keys(datapoint.data)),metricValue=datapoint.data[metricValueKey].value;return metricValue=Math.round(100*metricValue)/100};return me.readFeatureMetrics(workspaces).then({success:function(values){_.each(workspaces,function(workspace,i){workspace.set("FeatureTIPValue",getLastTIPFromValue(values[i]))}),deferred.resolve([])}}),deferred.promise},setUserActivity:function(workspaces){var me=this,deferred=Ext.create("Deft.Deferred");return me.readWorkspaceSnapshots(workspaces).then({success:function(values){console.log("Workspace Snapshots:",values),_.each(workspaces,function(workspace,i){console.log("snapshot:",workspace.get("Name"),values[i]),workspace.set("WorkspaceUserActivity",values[i])}),deferred.resolve([])}}),deferred.promise},setWorkspacePortfolioItemCounts:function(workspaces){var me=this,type="PortfolioItem",deferred=Ext.create("Deft.Deferred");return me.readWorkspaceTypeSnapshots(workspaces,type).then({success:function(values){console.log("["+type+"] Workspace Snapshots:",values),_.each(workspaces,function(workspace,i){console.log("["+type+"] snapshot:",workspace.get("Name"),values[i]),workspace.set(type+"Count",values[i])}),deferred.resolve([])}}),deferred.promise},setWorkspaceStoryCounts:function(workspaces){var me=this,type="HierarchicalRequirement",deferred=Ext.create("Deft.Deferred");return me.readWorkspaceTypeSnapshots(workspaces,type).then({success:function(values){console.log("["+type+"] Workspace Snapshots:",values),_.each(workspaces,function(workspace,i){console.log("["+type+"] snapshot:",workspace.get("Name"),values[i]),workspace.set(type+"Count",values[i])}),deferred.resolve([])}}),deferred.promise},setWorkspaceDefectCounts:function(workspaces){var me=this,type="Defect",deferred=Ext.create("Deft.Deferred");return me.readWorkspaceTypeSnapshots(workspaces,type).then({success:function(values){console.log("["+type+"] Workspace Snapshots:",values),_.each(workspaces,function(workspace,i){console.log("["+type+"] snapshot:",workspace.get("Name"),values[i]),workspace.set(type+"Count",values[i])}),deferred.resolve([])}}),deferred.promise},readWorkspaceTypeSnapshots:function(workspaces,type){var createTypeFind=function(type){var find={_ValidFrom:{$gt:moment().subtract(60,"days").toISOString()},_TypeHierarchy:{$in:[type]}};return find},me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me.loadASnapShotStoreWithAPromise(createTypeFind(type),["_TypeHierarchy","ObjectID"],["_TypeHierarchy"],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){console.log("error",error),deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},readWorkspaceSnapshots:function(workspaces){var createSnapshotFind=function(workspace){var find={_ValidFrom:{$gt:moment().subtract(30,"days").toISOString()}};return find},me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me.loadASnapShotStoreWithAPromise(createSnapshotFind(workspace),["_User"],[],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){console.log("error",error),deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},setProjectCounts:function(workspaces){var me=this,deferred=Ext.create("Deft.Deferred");return me.readProjects(workspaces).then({success:function(values){console.log("project values",values),_.each(workspaces,function(workspace,i){workspace.set("WorkspaceProjects",values[i]),workspace.set("ProjectsCount",values[i].length)}),deferred.resolve([])}}),deferred.promise},setUserCounts:function(workspaces){console.log("Getting Users");var me=this,deferred=Ext.create("Deft.Deferred");return me.readUsers(workspaces).then({success:function(values){_.each(workspaces,function(ws,i){ws.set("UserWorkspaceCount",values[i].length)}),deferred.resolve([])}}),deferred.promise},readProjects:function(workspaces){var me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("Project",["Name","State"],[],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},readPortfolioItems:function(workspaces){var createFeatureFilter=function(){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:">",value:"2015-01-01T00:00:00.000Z"});return filter},me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("HierarchicalRequirement",["FormattedID"],[createFeatureFilter()],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){console.log("error",error),deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},readFeatureMetrics:function(workspaces){var insightsAPI=function(workspace){var deferred=Ext.create("Deft.Deferred"),metrics=["TimeInProcessStoryAndDefectP50"],workspace=workspace.get("ObjectID"),lastMonth=moment(),firstMonth=moment().subtract(6,"months"),baseUrl="https://rally1.rallydev.com/insight/data",granularity="month",url=baseUrl+"?"+"granularity="+granularity+"&metrics="+metrics.join()+"&workspaces="+workspace+"&start-date="+firstMonth.format("YYYY-MM")+"&end-date="+lastMonth.format("YYYY-MM");return Ext.Ajax.request({url:url,success:function(response,opts){var obj=Ext.decode(response.responseText);deferred.resolve(obj)},failure:function(response,opts){console.log("server-side failure with status code "+response.status)}}),deferred.promise},me=this,promises=_.map(workspaces,function(workspace){return insightsAPI(workspace)});return Deft.Promise.all(promises)},readWorkspaces:function(){var deferred=Ext.create("Deft.Deferred");return this._loadAStoreWithAPromise("Subscription",["Name","Workspaces"]).then({success:function(subs){var sub=_.first(subs);sub.getCollection("Workspaces").load({fetch:["ObjectID","Name","State"],callback:function(records,operation,success){console.log("workspaces",_.map(records,function(r){return r.get("Name")}));var recs=_.filter(records,function(r){return"Closed"!==r.get("State")&&-1==r.get("Name").toLowerCase().indexOf("kfwang")});console.log("Workspace Count:",recs.length),deferred.resolve(recs)}})},scope:this}),deferred.promise},readUsers:function(workspaces){var usersFilter=function(){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"WorkspacePermission",operator:"!=",value:"No Access"});return filter=filter.and(Ext.create("Rally.data.wsapi.Filter",{property:"Disabled",operator:"=",value:!1}))},me=this,promises=_.map(workspaces,function(workspace){var deferred=Ext.create("Deft.Deferred");return me._loadAStoreWithAPromise("User",["UserName"],[usersFilter()],{workspace:workspace.get("_ref"),project:null}).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){deferred.resolve([])}}),deferred.promise});return Deft.Promise.all(promises)},_loadAStoreWithAPromise:function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise},loadASnapShotStoreWithAPromise:function(find,fetch,hydrate,ctx){var me=this,deferred=Ext.create("Deft.Deferred"),config={find:find,fetch:fetch,hydrate:hydrate,pageSize:1e3};_.isUndefined(ctx)||(config.context=ctx);var storeConfig=Ext.merge(config,{removeUnauthorizedSnapshots:!0,autoLoad:!0,listeners:{load:function(store,data,success){console.log("snapshots success",store,success,_.isNull(data)?"null":data.length,store.totalCount),deferred.resolve(store.totalCount)}}});return Ext.create("Rally.data.lookback.SnapshotStore",storeConfig),deferred.promise},getSettingsFields:function(){var me=this,yAxisStore=new Ext.data.ArrayStore({fields:["type"],data:[["PortfolioItem"],["Story"],["Defect"]]});return[{name:"yAxisType",xtype:"combo",store:yAxisStore,valueField:"type",displayField:"type",queryMode:"local",forceSelection:!0,boxLabelAlign:"after",fieldLabel:"Y Axis Type",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:"Select the Type to use for the Y Axis Value"}]}});
                Ext.define("Rally.technicalservices.lahChart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{colors:["#E0E0E0","#00a9e0","#fad200","#8dc63f"],chart:{type:"bubble"},title:{text:"Progress by Project"},xAxis:{title:{text:"Median Story TIP"}},yAxis:[{title:{text:"60 Day Activity"}}],plotOptions:{bubble:{tooltip:{headerFormat:"<b>{series.name}</b><br>",pointFormat:"PortfolioItems:{point.portfolioitems} Stories:{point.stories} Defects:{point.defects} <br>TIP:{point.x}, Portfolio Items:{point.y}, Users:{point.z}<br>Story Activity Ratio:{point.featureRatio} User Activity Ratio:{point.activityRatio} Snapshots:{point.snapshots}"}}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"LastActionHero",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
